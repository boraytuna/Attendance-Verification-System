{% extends 'base.html' %}

{% block content %}
    <h1>Calendar</h1>

    <div class="calendar-container">
        <div class="calendar-header">
            <button id="prevMonth">&lt;</button>
            <h2 id="monthYear"></h2>
            <button id="nextMonth">&gt;</button>
        </div>
        <div class="calendar-grid" id="calendar"></div>
    </div>

    <!-- âœ… Modal for Event Details -->
  <div id="eventModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2 id="modalTitle"></h2>
      <p><strong>Date:</strong> <span id="modalDate"></span></p>
      <p><strong>Time:</strong> <span id="modalTime"></span></p>
      <p><strong>Location:</strong> <span id="modalLocation"></span></p>
    </div>
  </div>


    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const calendarEl = document.getElementById("calendar");
            const monthYearEl = document.getElementById("monthYear");
            const prevMonthBtn = document.getElementById("prevMonth");
            const nextMonthBtn = document.getElementById("nextMonth");

            let currentDate = new Date();

            function generateCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();

    monthYearEl.textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(date);
    calendarEl.innerHTML = ""; // Clear existing content

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    calendarEl.classList.add("calendar-grid");

    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.classList.add("calendar-cell", "empty");
        calendarEl.appendChild(emptyCell);
    }

    for (let day = 1; day <= lastDate; day++) {
        const cell = document.createElement("div");
        cell.classList.add("calendar-cell");
        cell.dataset.date = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        cell.innerHTML = `<strong>${day}</strong><div class="event-list"></div>`;
        calendarEl.appendChild(cell);
    }

    loadEvents();
}


function loadEvents() {
    fetch("/api/events")
        .then(response => response.json())
        .then(events => {
            events.forEach(event => {
                const cell = document.querySelector(`[data-date='${event.eventDate}']`);
                if (cell) {
                    const eventDiv = document.createElement("div");
                    eventDiv.classList.add("event-item");
                    eventDiv.textContent = event.eventName;
                    eventDiv.addEventListener("click", function(e) {
                        e.stopPropagation(); // Prevent click from bubbling
                        showModal(event);
                    });
                    cell.querySelector(".event-list").appendChild(eventDiv);
                }
            });
        });
}

// Modal logic
const modal = document.getElementById("eventModal");
const closeButton = document.querySelector(".close-button");

function showModal(event) {
    document.getElementById("modalTitle").textContent = event.eventName;
    document.getElementById("modalDate").textContent = event.eventDate;
    document.getElementById("modalTime").textContent = `${event.startTime} - ${event.stopTime}`;
    document.getElementById("modalLocation").textContent = event.eventAddress || `${event.latitude}, ${event.longitude}`;
    modal.style.display = "block";
}

closeButton.onclick = () => { modal.style.display = "none"; }
window.onclick = function(event) {
    if (event.target === modal) {
        modal.style.display = "none";
    }
};

            prevMonthBtn.addEventListener("click", function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate);
            });

            nextMonthBtn.addEventListener("click", function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate);
            });

            generateCalendar(currentDate);
        });
    </script>
{% endblock %}