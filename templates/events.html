{% extends 'base.html' %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div style="margin-bottom: 20px;">
    {% for category, message in messages %}
    <div class="flash-message {{ category }}"
        style="background-color: #f8d7da; color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
        {{ message }}
        <button onclick="this.parentElement.style.display='none'"
            style="background: none; border: none; font-weight: bold; cursor: pointer;">‚úñ</button>
    </div>
    {% endfor %}
</div>
<script>
    setTimeout(() => {
        const alerts = document.querySelectorAll('.flash-message');
        alerts.forEach(alert => alert.style.display = 'none');
    }, 4000);
</script>
{% endif %}
{% endwith %}

<script>
    function handleLocationSelection() {
        var selectedValue = document.getElementById("saved_locations").value;
        var locationError = document.getElementById("location_error");

        if (selectedValue) {
            var [lat, lng] = selectedValue.split(",").map(Number);
            document.getElementById("event_location").value = `${lat},${lng}`;
            locationError.style.display = "none";
        }
    }

    function validateLocation(event) {
        var location = document.getElementById("event_location").value;
        var selectedValue = document.getElementById("saved_locations").value;
        var locationError = document.getElementById("location_error");

        if (!location && !selectedValue) {
            event.preventDefault();
            locationError.style.display = "block";
            return false;
        }
        return true;
    }

    window.onload = function () {
        fetch("/api/places")
            .then(response => response.json())
            .then(places => {
                var select = document.getElementById("saved_locations");
                places.forEach(place => {
                    var option = document.createElement("option");
                    option.value = `${place.latitude},${place.longitude}`;
                    option.textContent = `${place.name} (${place.building})`;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error("Error fetching places:", error));
    };

    let isFormDirty = false;
    document.querySelectorAll("input, textarea, select").forEach(el => {
        el.addEventListener("input", () => isFormDirty = true);
    });

    window.addEventListener("beforeunload", function (e) {
        if (isFormDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        margin: 30px;
        background-color: #f5f6f7;
        color: #333;
    }

    .content-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .title-container {
        text-align: center;
        margin-bottom: 20px;
        width: 100%;
    }

    h1 {
        color: #0056b3;
        font-size: 24px;
        margin-bottom: 10px;
    }

    .form-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    form {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 100%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    td {
        padding: 10px;
    }

    label {
        font-weight: bold;
    }

    input,
    button,
    select {
        margin-top: 5px;
        padding: 10px;
        width: 100%;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

    button {
        background-color: #0056b3;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #004494;
    }

    #location_error {
        color: red;
    }
</style>

<body>
    <div class="content-container">
        <div class="title-container">
            <h1>üéì Event Management</h1>
        </div>

        <div class="form-container">
            <form action="/submit_event" method="post">
                <table>
                    <tr>
                        <td><label for="event_name">Event Name:</label></td>
                        <td><input type="text" id="event_name" name="event_name" required></td>
                    </tr>
                    <tr>
                        <td><label for="event_date">Event Date:</label></td>
                        <td><input type="date" id="event_date" name="event_date" required></td>
                    </tr>
                    <tr>
                        <td><label for="start_time">Start Time:</label></td>
                        <td><input type="time" id="start_time" name="start_time" required></td>
                    </tr>
                    <tr>
                        <td><label for="stop_time">End Time:</label></td>
                        <td><input type="time" id="stop_time" name="stop_time" required></td>
                    </tr>
                    <tr>
                        <td><label for="saved_locations">Choose a Location:</label></td>
                        <td>
                            <select id="saved_locations" onchange="handleLocationSelection()">
                                <option value="">-- Select a saved location --</option>
                            </select>
                        </td>

                    </tr>
                    <select name="recurrence">
                        <option value="none">Does not repeat</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                      </select>
                      
                    <tr>
                        <td colspan="2">
                            <button type="button" onclick="window.location.href='http://127.0.0.1:5000/places'">‚ûï Create
                                New Place</button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input type="hidden" id="event_location" name="event_location">
                            <p id="location_error" style="display: none;">‚ö†Ô∏è Please select a location before submitting.
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <button type="submit" onclick="validateLocation(event)">Create Event</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</body>

{% endblock %}